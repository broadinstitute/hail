resources:
# service accounts
- name: vdc-sa
  type: iam.v1.serviceAccount
  properties:
# must be 6-30 characters
    accountId: vdc-sa
    displayName: for vdc
- name: gcr-push
  type: iam.v1.serviceAccount
  properties:
    accountId: gcr-push
    displayName: push to gcr.io
- name: gcr-pull
  type: iam.v1.serviceAccount
  properties:
    accountId: gcr-pull
    displayName: pull to gcr.io
- name: k8s-admin
  type: iam.v1.serviceAccount
  properties:
    accountId: k8s-admin
    displayName: pull to gcr.io
# buckets
# deployment manager cannot create artifacts.@project@.appspot.com
# -N serializes otherwise you get conflicts
- name: gcr-push-artifacts-1-bucket-owner
  type: storage.v1.bucketAccessControl
  metadata:
    dependsOn:
    - gcr-push
  properties:
    bucket: artifacts.@project@.appspot.com
    entity: user-gcr-push@@project@.iam.gserviceaccount.com
    role: "OWNER"
- name: gcr-push-artifacts-2-object-owner
  type: storage.v1.defaultObjectAccessControl
  metadata:
    dependsOn:
    - gcr-push
    - gcr-push-artifacts-1-bucket-owner
  properties:
    bucket: artifacts.@project@.appspot.com
    entity: user-gcr-push@@project@.iam.gserviceaccount.com
    role: "OWNER"
- name: gcr-pull-artifacts-3-bucket-reader
  type: storage.v1.bucketAccessControl
  metadata:
    dependsOn:
    - gcr-pull
    - gcr-push-artifacts-2-object-owner
  properties:
    bucket: artifacts.@project@.appspot.com
    entity: user-gcr-pull@@project@.iam.gserviceaccount.com
    role: "READER"
- name: gcr-pull-artifacts-4-object-reader
  type: storage.v1.defaultObjectAccessControl
  metadata:
    dependsOn:
    - gcr-pull
    - gcr-pull-artifacts-3-bucket-reader
  properties:
    bucket: artifacts.@project@.appspot.com
    entity: user-gcr-pull@@project@.iam.gserviceaccount.com
    role: "READER"
- name: vdc-sa-artifacts-5-bucket-reader
  type: storage.v1.bucketAccessControl
  metadata:
    dependsOn:
    - gcr-pull
    - gcr-pull-artifacts-4-object-reader
  properties:
    bucket: artifacts.@project@.appspot.com
    entity: user-vdc-sa@@project@.iam.gserviceaccount.com
    role: "READER"
- name: vdc-sa-artifacts-6-object-reader
  type: storage.v1.defaultObjectAccessControl
  metadata:
    dependsOn:
    - vdc-sa
    - vdc-sa-artifacts-5-bucket-reader
  properties:
    bucket: artifacts.@project@.appspot.com
    entity: user-vdc-sa@@project@.iam.gserviceaccount.com
    role: "READER"
# gke cluster
- name: vdc-gke-cluster
  type: container.v1.cluster
  metadata:
    dependsOn:
    - vdc-sa
  properties:
    zone: @zone@
    cluster:
      addonsConfig:
        httpLoadBalancing: {}
        kubernetesDashboard: {disabled: true}
      initialClusterVersion: 1.10.7-gke.6
      ipAllocationPolicy: {useIpAliases: true}
      location: @zone@
      loggingService: logging.googleapis.com
      masterAuth:
        clientCertificateConfig: {}
      masterAuthorizedNetworksConfig: {}
      monitoringService: monitoring.googleapis.com
      name: vdc
      network: projects/@project@/global/networks/default
      networkPolicy: {}
      nodePools:
      - autoscaling: {}
        config:
          diskSizeGb: 100
          diskType: pd-standard
          imageType: COS
          serviceAccount: vdc-sa@@project@.iam.gserviceaccount.com
          machineType: n1-standard-1
          oauthScopes: ['https://www.googleapis.com/auth/devstorage.read_only', 'https://www.googleapis.com/auth/logging.write',
            'https://www.googleapis.com/auth/monitoring', 'https://www.googleapis.com/auth/servicecontrol',
            'https://www.googleapis.com/auth/service.management.readonly', 'https://www.googleapis.com/auth/trace.append']
        initialNodeCount: 3
        management: {autoRepair: true}
        name: default-pool
        version: 1.10.7-gke.6
      - autoscaling: {enabled: true, maxNodeCount: 6}
        config:
          diskSizeGb: 100
          diskType: pd-standard
          imageType: COS
          labels: {preemptible: 'true'}
          serviceAccount: vdc-sa@@project@.iam.gserviceaccount.com
          machineType: n1-standard-8
          oauthScopes: ['https://www.googleapis.com/auth/devstorage.read_only', 'https://www.googleapis.com/auth/logging.write',
            'https://www.googleapis.com/auth/monitoring', 'https://www.googleapis.com/auth/servicecontrol',
            'https://www.googleapis.com/auth/service.management.readonly', 'https://www.googleapis.com/auth/trace.append']
          preemptible: true
          taints:
          - {effect: NO_SCHEDULE, key: preemptible, value: 'true'}
        management: {autoRepair: true}
        name: preemptible-pool
        version: 1.10.7-gke.6
      privateClusterConfig: {}
      subnetwork: projects/@project@/regions/@region@/subnetworks/default
